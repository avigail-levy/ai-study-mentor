CREATE EXTENSION IF NOT EXISTS vector;

CREATE TABLE categories (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    row_index SMALLINT NOT NULL,
    col_index SMALLINT NOT NULL,
    gemini_embedding VECTOR(768) NULL
);

CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    email VARCHAR(100) UNIQUE NOT NULL,
    full_name VARCHAR(100)
);

CREATE TABLE user_shopping_items (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    item_name VARCHAR(255) NOT NULL,
    mapped_category_id INTEGER REFERENCES categories(id),
    calculated_order SMALLINT
);

INSERT INTO users (email, full_name) VALUES
('tester1@example.com', 'משה כהן') 
ON CONFLICT (email) DO NOTHING;

INSERT INTO users (email, full_name) VALUES
('tester2@example.com', 'דניאלה לוי') 
ON CONFLICT (email) DO NOTHING;

INSERT INTO users (email, full_name) VALUES
('zipi.3382@gmail.com', 'ציפי סלומון') 
ON CONFLICT (email) DO NOTHING;

CREATE INDEX ON categories
USING ivfflat (gemini_embedding vector_l2_ops)
WITH (lists = 100);

INSERT INTO categories (name, row_index, col_index) VALUES
('סבונים, אבקת כביסה, מרכך כביסה, כביסה, שמפו, מרכך, סבון גוף', 0, 0),
('גומיות שיער, מברשות, פדים, קרם שיער, קליפסים, חומרי רצפה, חומרי ניקוי, מוצרי שיער', 1, 0),
('מברשות ומשחות שיניים, קיסמים, אוזניים ושיניים, סבון כלים, מדיח כלים, כריות וסקוצ''ים לכלים', 2, 0),
('דליים, מגב לשיש, מגב רצפה, מטאטא, כף אשפה', 3, 0),
('חד פעמי, ספוג הפלא, סקוצ לסירים', 4, 0),
('חד פעמי, מפיות, כפפות, נרות, תרסיס לשירותים, תבניות אלומיניום', 5, 0),
('שקיות אשפה, שקיות אוכל, נייר כסף, נייר נצמד, שקיות קוקי', 6, 0),
('מארזי שתייה רגילה, מארזי שתייה מוגזת', 7, 0),
('סוכריות, ממתקים, מטרנה, גרברים, נשכני תינוקות, דייסה, מוצרי תינוקות, מחית פירות', 0, 1),
('שוקולדים, חלווה, מוצצים, בקבוקים לתינוקות', 1, 1),
('מוצרי אפייה, ממרחים, שוקולד, ריבות, טיטולים, מגבונים', 2, 1),
('מוצרי אפייה, אבקת אפייה, סוכר וניל, קקאו, אבקת סוכר, תמצית וניל, קוקוס, טישו, נייר טואלט, נייר סופג', 3, 1),
('שתייה מתוקה יחידים, בקבוקים גדולים', 4, 1),
('שתייה מתוקה בקבוקים קטנים, שתייה מתוקה יחידים', 5, 1),
('בקבוקי מים גדולים, בקבוקי מים קטנים, מים בטעמים, שתייה עדינה', 6, 1),
('שתייה מוגזת בקבוקים גדולים, שתייה מוגזת בקבוקים קטנים, שתייה מוגזת יחידים', 7, 1),
('שוקו, תה, קפה, אבקת אייס קפה, סוכרזית', 0, 2),
('עוגיות סנדוויץ'', עוגיות מצופות, חיוכים, חטיפי אנרגיה, ופלים, גליליות', 1, 2),
('דגני בוקר, עוגיות נוספות, חטיפי אנרגיה, עוגיות עוגי', 2, 2),
('חטיפים מלוחים, קרקרים מלוחים, ביסקוויטים', 3, 2),
('מיץ ענבים, פירות הדר, לימונים', 4, 2),
('יין, פירות הדר', 5, 2),
('בירה, פירות הדר', 6, 2),
('קצבייה, עוף טרי', 7, 2),
('אבקת פטריות, מנות חמות, אבקת מרק, שקדי מרק, תבלינים', 0, 3),
('שימורים, טונה, תירס, זיתים, פסטות, קוסקוס', 1, 3),
('פירורי לחם, קטניות, קינואה, אורז, רטבים, קטשופ, צ''ילי, מיונז, חרדל, רוטב סויה טריאקי', 2, 3),
('שמן זית, מיץ לימון, שמן, חומץ, קמח, סוכר, מלח', 3, 3),
('ירקות, מלפפון, עגבנייה', 4, 3),
('ירקות, קישוא, בטטה, תפוחי אדמה, בצל, חציל', 5, 3),
('פירות', 6, 3),
('קצבייה, בשר טרי', 7, 3),
('חלב, שתייה חלבית, גלידות, ארטיקים, ביצים', 0, 4),
('גבינות בטעמים, בצקים קפואים', 1, 4),
('מעדנים, יוגורטים, דגים', 2, 4),
('מוצרי אפייה קרה, קצפת ושמנת, עופות ובשר קפוא', 3, 4),
('גבינות מיוחדות, גבינות קשות, גבינות רכות', 4, 4),
('חמאה, מחמאה, מרגרינה, שמנת מתוקה, רביולי', 5, 4),
('פסטרמות, נקניקיות, בשר מעושן', 6, 4),
('טורטיות, לחם, לחמניות, פיתות, פריכיות', 7, 4);

DELETE FROM USERS;
DELETE FROM categories;
delete from user_shopping_items;
SELECT
    id,
    name,
    gemini_embedding
FROM
    categories
WHERE
    gemini_embedding IS NOT NULL
LIMIT 5; -- הגבל ל-5 שורות רק לבדיקה ראשונית
SELECT * FROM user_shopping_items;

SELECT 
    i.item_name, 
    c.row_index,
    c.col_index 
FROM 
    user_shopping_items i
JOIN 
    categories c ON i.mapped_category_id = c.id
WHERE 
    i.item_name = 'גומיות שיער' AND i.user_id = 1;
SELECT
    i.item_name,
    c.name AS mapped_category_name,
    c.row_index,
    c.col_index,
    i.calculated_order
FROM
    user_shopping_items i
JOIN
    categories c ON i.mapped_category_id = c.id
WHERE
    i.user_id = 1
ORDER BY
    i.calculated_order ASC;
SELECT * FROM user_shopping_items WHERE user_id = 6;
select * from categories;

SELECT id, item_name
FROM user_shopping_items
WHERE user_id =1 AND mapped_category_id IS NULL
select * from users;

SELECT id
    FROM categories
    WHERE gemini_embedding IS NOT NULL
    ORDER BY gemini_embedding <->'
vectorSt [-0.003321783,0.01909037,-0.012229116,-0.026335852,0.024200585,-0.0046963417,-0.009183133,-0.0032142142,-0.026608152,0.04753084,-0.01155712,0.009400039,0.06496163,-0.0020361836,-0.0020170587,-0.058613468,0.042457256,0.024614612,-0.099986985,0.013990094,0.03418393,-0.0064210743,0.05575169,0.014903006,-0.02633743,-0.027200164,-0.016194467,0.016233549,-0.016920941,-0.010514096,0.048876297,0.06792954,0.03633474,-0.03455782,0.040298734,0.047964107,0.013122725,0.0435203,0.022134233,-0.037263498,-0.08300198,0.0071465005,-0.029266298,0.03140027,-0.029175216,-0.014913763,-0.014474391,0.052997667,-0.03522443,0.034750372,0.019360078,0.013783648,-0.049688037,0.021821197,-0.029618273,-0.013543884,-0.0020958849,0.0034147773,0.020091703,-0.007021189,-0.032550298,0.024126062,-0.039270744,-0.03269794,0.010887778,-0.0072123967,-0.024550691,-0.031652726,-0.07324031,0.045268007,-0.008063478,-0.008180212,-0.046773292,-0.00010722119,0.018800179,-0.051869582,0.01031641,-0.034575332,0.0022360003,0.07068209,-0.05412163,0.044303987,0.050696965,0.08069854,-0.009097737,-0.0031177734,0.03958732,-0.09247039,-0.06610642,0.0038085592,0.1314687,0.049853474,-0.005071466,-0.03295565,0.07319058,-0.02300962,-0.11412747,-0.14942835,0.13147715,0.05191965,0.0016506169,0.010827442,-0.036112975,-0.04455158,0.028769331,0.045267783,-0.016591908,-0.041454393,-0.012330489,0.029722856,-0.06350792,-0.039875116,0.016949395,0.032186445,-0.002323435,0.018016595,-0.013846644,0.0054983133,-0.033996318,0.01887481,-0.006122723,-0.0024637068,-0.011170596,0.064663656,0.026136983,-0.010313465,0.031032145,-0.012262294,-0.013117706,0.016186003,0.051558793,-0.041288905,0.012181141,0.026049087,-0.027185457,-0.025740117,0.01838341,-0.014059397,0.049989566,0.02022522,0.0116421115,-0.048722204,-0.03028128,0.010400252,0.0006262256,-0.021729631,-0.003906241,0.045710675,-0.023008272,-0.047285255,-0.054417506,0.0045542098,0.064412,-0.027589612,-0.008116596,-0.006214252,0.05070182,-0.0426173,0.017994465,-0.008769922,0.06003874,-0.07321031,-0.0058807856,0.013304268,-0.037407927,0.01301386,0.005859086,-0.06481009,-0.015732324,0.010356987,-0.030375315,-0.012712576,-0.029336588,-0.14932227,0.023764743,-0.0055014323,-0.023443153,0.0032852117,0.007567382,0.013567201,0.091374174,0.014498186,-0.031978704,-0.09511021,0.024650179,-0.015506711,0.04270828,0.020950405,0.08252685,0.021777418,-0.02718274,0.014585578,0.014293438,0.047996003,-0.02323288,0.0014935005,-0.010152644,0.011280589,-0.0174641,-0.05894568,0.047163777,-0.03076367,-0.012951984,-0.018899081,-0.0036011466,0.034013808,-0.05544924,-0.040840685,-0.026331522,0.010683784,0.016102286,-0.004326047,-0.015749335,-0.02908118,0.04787404,0.0060053896,0.051089723,-0.0005859,0.016474897,0.0054020174,0.0072075073,0.020727172,0.017962508,0.033753775,0.018659435,-0.012469368,-0.052541554,-0.027747247,0.030701702,-0.0047954386,-0.004932431,0.013441298,0.030592114,0.005572359,-0.05761131,0.030823719,0.029572215,-0.063149184,-0.036360465,0.005326059,-0.01360919,0.048467033,0.07089262,0.014952002,0.057717025,-0.0563209,0.060190164,0.029229915,-0.004341688,-0.03352053,-0.019873662,-0.045991074,0.0034066145,-0.023721026,-0.06295159,-0.049053747,0.04131475,-0.009207077,0.01646246,-0.036960796,0.041168902,0.016862512,-0.0036827335,-0.06834614,-0.026767783,-0.07172437,-0.0041128495,0.012829473,0.061308745,-0.050769247,0.013324793,-0.060670365,-0.04385461,-0.020880839,-0.023870576,0.025826793,-0.0054663904,-0.0080602355,0.02750077,-0.06710176,0.022320148,0.013879987,-0.037632305,0.016175063,0.010449787,-0.08102141,0.013926839,0.010543209,-0.003248011,-0.004858109,0.046774972,0.028174167,0.014701699,-0.041364424,0.041978143,0.0019511693,0.041651875,0.0011690415,-0.038270656,-0.001750445,0.0052712276,0.05870811,-0.03595724,0.03161325,0.0416085,-0.0037988708,-0.019705843,-0.006658954,-0.0364048,0.020655932,-0.004701202,0.050777905,-0.035926737,-0.03998831,-0.022852903,-0.016435279,-0.16374886,-0.031290248,-0.0020066719,0.013213856,-0.014669285,0.050516114,0.012381032,0.026395546,-0.021569714,-0.0086916,-0.013804925,-0.009243858,0.008364214,0.021886574,0.037476473,-0.0091885775,-0.051739704,-0.035648886,0.0037192826,0.015567152,-0.07922316,0.00015235007,0.048989072,0.03892638,0.04005707,0.016325736,0.04394668,0.03143512,-0.0058545875,-0.084519766,0.0013633398,-0.0070744306,0.010058751,0.0415294,0.015508017,0.09819912,0.005642264,-0.07738985,-0.0005603897,-0.014412393,0.056764584,-0.015464609,-0.0022776225,-0.016078891,-0.001953799,0.0016613456,-0.0060493015,-0.0046046334,0.03236452,0.008829126,0.019467829,0.03704341,-0.039924823,-0.028286997,-0.028600287,0.025268955,-0.027010672,-0.013622088,0.01591673,-0.0007075929,-0.03892923,0.0005048238,-0.011143022,0.02762526,-0.023864148,0.004832159,0.0039989143,0.047165945,-0.026496777,0.08233625,-0.0324997,-0.02500129,0.011211676,-0.0030910731,0.0032689148,0.03729068,0.023736699,-0.0031800861,-0.0004599721,0.048440877,-0.019567912,0.042162888,-0.028715976,-0.0028874557,0.011031437,-0.028169723,0.10221386,-0.075398825,-0.022799807,-0.027541284,0.054589827,-0.014141469,0.011807196,0.03351684,-0.036501694,-0.029405804,-0.059562325,-0.008229969,-0.02193248,-0.0036149065,0.011631291,-0.032887094,-0.00017693039,0.016629107,-0.009203837,0.026657384,0.031219508,0.0034017444,0.0312013,-0.07885872,0.001761698,0.015714504,0.007722257,0.017301671,0.07127387,0.07072491,-0.001660874,0.08929033,0.07632102,0.024348835,-0.014635619,-0.025536815,-0.038993683,0.016011657,-0.027816515,-0.0011227544,0.040940173,0.020223822,-0.023442227,0.062402494,0.077582285,0.017503995,0.024384527,-0.022674693,-0.003245322,-0.0068449136,0.000004218494,-0.011895741,-0.07441469,-0.010478741,0.013464396,0.081262276,-0.024025472,0.0025084526,-0.031024994,-0.024357738,0.03338898,0.03398277,0.034761902,-0.0012851956,0.026575513,0.045796808,-0.07029531,0.049160052,0.030427283,0.0090052085,0.018492596,0.015228515,-0.012498344,-0.012147919,-0.0009087623,0.0076565905,-0.042233642,0.012055639,0.0037575369,0.027033573,-0.021250417,0.030446688,0.054764677,-0.04134146,-0.041029558,0.006991735,0.003577174,0.013939463,-0.02831769,0.022607453,-0.021942085,-0.027860457,-0.0054598465,0.009450671,0.0064323256,-0.04407932,-0.031943638,0.04931671,0.055526637,0.0077342177,-0.0014664807,-0.08668446,-0.018475452,0.020790813,-0.033231873,-0.04358977,0.0675556,0.014407085,0.06330473,-0.008466671,0.040390577,0.011759253,-0.048380733,-0.012509247,-0.031362515,0.03842765,-0.050084192,0.05693208,-0.022800693,0.0072620595,0.031927582,-0.019446459,0.008561123,0.0100067295,-0.0050621936,0.020291567,0.016253931,-0.08139461,-0.023599222,0.028275117,0.028095743,0.044437304,0.025988776,0.052791342,0.03330988,0.025174437,0.011708563,0.015644817,-0.006026154,0.023210106,-0.01279097,0.03930497,0.05874355,0.0026316291,0.0012360797,0.06831706,-0.008312041,0.09093442,0.00082996587,-0.043970913,-0.035157736,-0.011833066,-0.04443723,-0.035181977,0.029389426,-0.02378816,-0.04209977,-0.042569928,-0.016054345,-0.021745153,0.032013506,0.021834329,0.01128834,-0.009836529,0.02560758,0.032876223,-0.031286143,-0.0023623107,0.0074970983,0.018341754,0.0041481536,-0.017093014,0.044592384,0.003530897,-0.051601928,0.024310097,0.042641588,-0.0360413,0.000109154265,0.008460176,0.038552452,-0.0019714814,0.007483563,-0.025918303,0.013206551,0.0015493903,-0.0061419453,0.020106021,-0.02992853,0.041152354,0.015215234,-0.06661597,0.00001929149,0.00820642,-0.017476715,0.022061387,0.043819435,0.011758123,-0.02418881,0.013222657,0.030137638,0.028083833,-0.017454214,-0.050163668,-0.024402404,-0.0349812,-0.015529912,-0.030779198,-0.018992605,0.025755696,-0.044909958,0.0118225245,-0.022650793,-0.018510407,-0.016171675,0.013900079,0.01430066,0.025577737,0.005441248,-0.00772111,0.019997165,-0.0025844087,-0.08716358,0.03732181,-0.022481129,-0.010385065,0.03293583,0.01360593,-0.005057981,0.032078627,0.023129681,-0.0057271505,-0.021889366,0.018786991,0.0019872342,-0.015287041,-0.010214311,-0.030829553,0.012660366,0.018579038,0.050589323,0.018626574,-0.043269277,0.021509264,0.016526263,-0.0075109582,0.00045360642,0.034826975,0.0057913163,0.022744289,-0.018042253,0.048205275,-0.023787292,0.051149916,-0.05471647,-0.026938388,0.013201476,0.0089195585,-0.0065745367,-0.03888592,-0.0026982673,0.014784012,0.005560681,-0.011513707,-0.0018835112,0.0122032445,0.01081057,-0.015193953,0.028590472,0.010120003,-0.03313558,0.009749367,-0.051221,0.00034233075,0.036767475,-0.015638731,-0.019067584,0.017864976,-0.0052013667,-0.02427319,-0.0158911,-0.02120157,0.015227702,-0.00027179334,0.050404582,0.0141869765,-0.05815491,0.040115763,0.022428764,-0.04608295,-0.027743775,-0.008056374,0.013611745,0.039815336,0.011809452,-0.009843726,-0.029935222,0.012807499,-0.065259576,-0.017036222,-0.052847438,-0.033057336,0.015355655,0.006512881,0.037789926,0.026002409,-0.013098529,0.023350373,0.0065275067,0.010521335,-0.011471656,-0.0048249573,-0.02579944,0.015239332,0.014582712,0.008634301,0.018900441,0.01162021,0.011117329,-0.021357233,0.060891222,0.024244424,0.05575643,0.030988507,-0.094990544,-0.018183263,-0.07194127,0.07195569,0.03761051,0.0026968024,0.007624199,0.017062534,-0.010180063,-0.024783827,-0.011461685,-0.03006599,-0.049201015,-0.04872844,0.021124274,-0.018274734,-0.05662066,-0.034619164,-0.049529728,-0.014058156,0.0032921599,-0.028371707,-0.02519998,-0.013679882,-0.08544678,-0.01794184,0.0042538135,0.011922783,0.03547172,-0.018938564,0.00012768026,-0.013600104,0.040861614,0.029489186,-0.031579673,0.09296492,0.0043878304,-0.008345245,-0.07809256,-0.007881871,0.055013634,-0.07222152]'::vector
	LIMIT 1;